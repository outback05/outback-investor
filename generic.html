<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Outback Investor — Generic Rebalance Builder</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#0f1115;
      --card:#161a22;
      --text:#e9edf5;
      --muted:#98a2b3;
      --line:#2a3040;
      --accent:#d6a24a;
      --yellow:#fff3b0;
      --yellow2:#ffe082;
      --danger:#ff5c5c;
      --ok:#4ade80;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(214,162,74,.18), transparent 60%),
        radial-gradient(900px 600px at 80% 0%, rgba(255,224,130,.10), transparent 60%),
        var(--bg);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:24px}
    a{color:var(--accent)}
    .topbar{
      display:flex;align-items:center;gap:14px;
      background:rgba(22,26,34,.6);
      border:1px solid rgba(42,48,64,.7);
      box-shadow:var(--shadow);
      border-radius:var(--radius);
      padding:14px 16px;
      backdrop-filter: blur(10px);
    }
    .logo{
      width:38px;height:38px;flex:0 0 38px;
      display:grid;place-items:center;
      border-radius:12px;
      background: rgba(214,162,74,.10);
      border:1px solid rgba(214,162,74,.25);
      overflow:hidden;
    }
    .logo img{width:28px;height:28px;object-fit:contain;filter: drop-shadow(0 6px 10px rgba(0,0,0,.35));}
    .titles{display:flex;flex-direction:column;gap:2px}
    .h1{font-size:18px;font-weight:800;letter-spacing:.2px}
    .h2{font-size:13px;color:var(--muted)}
    .pill{margin-left:auto;display:flex;align-items:center;gap:10px;color:var(--muted);font-size:12px}
    .badge{font-size:11px;padding:6px 10px;border-radius:999px;border:1px solid rgba(42,48,64,.85);color:var(--muted)}
    .ok{color:var(--ok)}
    .err{color:var(--danger)}
    .grid{
      margin-top:18px;
      display:grid;
      grid-template-columns: 460px 1fr;
      gap:16px;
    }
    @media (max-width:1050px){ .grid{grid-template-columns:1fr} }
    .card{
      background:rgba(22,26,34,.75);
      border:1px solid rgba(42,48,64,.75);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      min-width:0;
    }
    .sectionTitle{
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;font-weight:800;font-size:14px;margin:0 0 10px 0;letter-spacing:.2px;
    }
    .subtle{font-size:12px;color:var(--muted);line-height:1.35}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,button{
      font-family:inherit;
      border-radius:12px;
      border:1px solid rgba(42,48,64,.9);
      background: rgba(15,17,21,.75);
      color:var(--text);
      padding:10px 12px;
      outline:none;
      min-width:0;
    }
    input:focus{border-color:rgba(214,162,74,.6);box-shadow:0 0 0 3px rgba(214,162,74,.15)}
    .field{flex:1;min-width:160px}
    .field.small{min-width:120px;flex:0 0 120px}
    .field.big{min-width:240px}
    .btn{
      cursor:pointer;
      border:1px solid rgba(214,162,74,.45);
      background: rgba(214,162,74,.12);
      color:var(--text);
      font-weight:700;
      padding:10px 14px;
    }
    .btn:hover{background: rgba(214,162,74,.18)}
    .btn2{
      cursor:pointer;
      border:1px solid rgba(42,48,64,.9);
      background: rgba(15,17,21,.55);
      color:var(--text);
      font-weight:700;
      padding:10px 14px;
    }
    .btn2:hover{background: rgba(15,17,21,.85)}
    .btnQuick{
      padding:8px 10px;border-radius:10px;font-size:12px;
      border:1px solid rgba(42,48,64,.9);
      background: rgba(15,17,21,.55);
      cursor:pointer;color:var(--text);
    }
    .btnQuick:hover{border-color:rgba(214,162,74,.55)}
    .highlightInput{
      background: var(--yellow);
      color:#111;
      border:1px solid rgba(214,162,74,.75);
      font-weight:900;
    }
    .boldYellow{
      color:#111;
      background: var(--yellow2);
      padding:6px 10px;
      border-radius:12px;
      font-weight:900;
      display:inline-block;
    }
    .hr{height:1px;background:rgba(42,48,64,.75);margin:14px 0}
    .table{
      width:100%;
      border-collapse:separate;
      border-spacing:0 10px;
      margin-top:8px;
    }
    .table th{
      text-align:left;
      font-size:11px;
      color:var(--muted);
      font-weight:700;
      padding:0 10px;
      white-space:nowrap;
    }
    .table td{
      padding:10px;
      background: rgba(15,17,21,.55);
      border:1px solid rgba(42,48,64,.75);
      vertical-align:middle;
    }
    .table tr td:first-child{border-radius:12px 0 0 12px}
    .table tr td:last-child{border-radius:0 12px 12px 0}
    .tickerCell{
      background: rgba(214,162,74,.12);
      border:1px solid rgba(214,162,74,.35);
      border-radius:12px;
      padding:10px 12px;
      font-family:var(--mono);
      font-weight:900;
      color:#fff; /* ticker text white */
      text-transform:uppercase;
      letter-spacing:.3px;
    }
    .money{font-variant-numeric: tabular-nums}
    .right{text-align:right}
    .center{text-align:center}
    .twoCharts{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      align-items:stretch;
    }
    @media (max-width:780px){ .twoCharts{grid-template-columns:1fr} }
    canvas{max-width:100%}

    /* Desktop layout fix: keep holdings grid stable */
    .holdingsWrap{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }

    /* Compact inputs in holdings rows */
    .tinyInput{
      padding:8px 10px;
      border-radius:10px;
    }
    .delBtn{
      cursor:pointer;
      border:1px solid rgba(255,92,92,.55);
      background: rgba(255,92,92,.12);
      color:var(--text);
      font-weight:800;
      padding:8px 10px;
      border-radius:10px;
    }
    .delBtn:hover{background: rgba(255,92,92,.18)}
    .footnote{font-size:11px;color:var(--muted);line-height:1.35;margin-top:10px}
  </style>
</head>

<body>
<div class="wrap">

  <div class="topbar">
    <div class="logo" title="Outback Investor">
      <img id="logoImg" alt="Outback Investor logo" />
    </div>
    <div class="titles">
      <div class="h1">Outback Investor <span style="opacity:.7">/</span> Rebalance Guide</div>
      <div class="h2">Generic Builder • Rebalance with new money only • Min $50 per buy • Max 50 holdings</div>
    </div>
    <div class="pill">
      <span class="badge" id="statusBadge">Saved locally</span>
    </div>
  </div>

  <div class="grid">

    <!-- LEFT -->
    <div class="card">
      <div class="sectionTitle">Welcome</div>

      <!-- Contribution + Calculate beside it -->
      <div class="row" style="align-items:flex-end;">
        <div class="field big">
          <label><strong>New Contribution ($)</strong></label>
          <input id="contribution" class="highlightInput money" inputmode="decimal" placeholder="e.g. 500" value="0" />
        </div>
        <div class="field small" style="flex:0 0 auto;min-width:auto">
          <button class="btn" id="calcBtn" type="button" style="height:44px;">Calculate</button>
        </div>
      </div>

      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
        <button class="btnQuick" type="button" data-q="50">$50</button>
        <button class="btnQuick" type="button" data-q="100">$100</button>
        <button class="btnQuick" type="button" data-q="150">$150</button>
        <button class="btnQuick" type="button" data-q="200">$200</button>
        <button class="btnQuick" type="button" data-q="250">$250</button>
        <button class="btnQuick" type="button" data-q="480">$480</button>
        <button class="btnQuick" type="button" data-q="0">Clear</button>
      </div>

      <div class="hr"></div>

      <div class="sectionTitle">
        <span class="boldYellow">Cash tracking</span>
      </div>

      <div class="row">
        <div class="field">
          <label>Cash Available to invest ($)</label>
          <input id="cashBetashares" class="money" inputmode="decimal" value="0" />
        </div>
        <div class="field">
          <label>Extra Cash Available to invest or consolidate ($)</label>
          <input id="cashExtra" class="money" inputmode="decimal" value="0" />
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="field">
          <label>Leftover cash for next investment ($)</label>
          <input id="cashRemainder" class="money" inputmode="decimal" value="0" />
        </div>
        <div class="field small">
          <label>Min buy ($)</label>
          <input id="minBuy" class="money" inputmode="decimal" value="50" />
        </div>
      </div>

      <div class="hr"></div>

      <div class="sectionTitle">
        <span class="boldYellow">Current holdings</span>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end">
          <button class="btn2" id="fetchBtn" type="button">Fetch prices</button>
          <button class="btn" id="addBtn" type="button">+ Add holding</button>
        </div>
      </div>

      <div class="subtle" style="margin-bottom:8px;">
        Enter Units and/or Price. Value auto-calculates immediately. Targets should total ~100%.
      </div>

      <div class="row" style="margin-bottom:8px;">
        <div class="field">
          <label>Live pricing CSV URL (optional)</label>
          <input id="csvUrl" placeholder="paste your published CSV url" />
        </div>
        <div class="field small">
          <button class="btn2" id="normBtn" type="button" style="height:44px;width:100%">Normalize %</button>
        </div>
      </div>

      <div class="holdingsWrap">
        <table class="table" id="holdingsTable">
          <thead>
            <tr>
              <th>Holdings (tickers)</th>
              <th class="right">Target %</th>
              <th class="right">Units</th>
              <th class="right">Price</th>
              <th class="right">Value ($)</th>
              <th class="center">Del</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="btn2" id="saveBtn" type="button">Save now</button>
        <button class="btn2" id="resetBtn" type="button">Clear all</button>
      </div>

      <div class="footnote">
        <strong>Rebalance logic:</strong> buy-only (no selling). Allocates new money into underweight assets, rounds down each buy
        to <strong>$minBuy blocks</strong>. Anything under minBuy becomes leftover cash for next investment.
      </div>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <div class="sectionTitle">
        <span class="boldYellow">What to buy Now</span>
        <span class="badge" id="summaryBadge">—</span>
      </div>

      <div class="row">
        <div class="field">
          <label>New investment ($)</label>
          <input id="investedOut" class="money" readonly />
        </div>
        <div class="field">
          <label>Leftover cash for next investment ($)</label>
          <input id="remainderOut" class="money" readonly />
        </div>
        <div class="field">
          <label>New Balance ($)</label>
          <input id="postTotalOut" class="money highlightInput" readonly />
        </div>
      </div>

      <div class="hr"></div>

      <table class="table" id="buyTable">
        <thead>
          <tr>
            <th>Holdings (tickers)</th>
            <th class="right">Current %</th>
            <th class="right">Target %</th>
            <th class="right">Diff</th>
            <th class="right">Buy $</th>
            <th class="right">New %</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="hr"></div>

      <div class="twoCharts">
        <div class="card" style="padding:12px;">
          <div class="sectionTitle" style="margin-bottom:8px;">Before</div>
          <canvas id="chartBefore" height="220"></canvas>
        </div>
        <div class="card" style="padding:12px;">
          <div class="sectionTitle" style="margin-bottom:8px;">After</div>
          <canvas id="chartAfter" height="220"></canvas>
        </div>
      </div>

      <div class="hr"></div>

      <div class="sectionTitle">How to use (fortnightly routine)</div>
      <ol class="subtle" style="margin:0;padding-left:18px;line-height:1.5;">
        <li>Update Units and/or Price (Value calculates automatically).</li>
        <li>Set the new contribution amount (or use quick buttons).</li>
        <li>Click <strong>Calculate</strong> — buy the assets shown with <strong>Buy $ &gt; 0</strong> (in <strong>$50 blocks</strong>).</li>
        <li>Anything &lt; min buy becomes leftover cash for next investment.</li>
      </ol>

      <div class="footnote">
        This generic builder saves locally (localStorage). If you open on another device, it starts fresh unless you re-enter values.
      </div>
    </div>

  </div>
</div>

<script>
/***********************
 * CONFIG
 ***********************/
const LOGO_FILE = "outback_symbol_extracted.png";
const STORAGE_KEY = "outback_generic_portfolio_v2";
const MAX_HOLDINGS = 50;

// If your CSV contains columns like: ticker,price
// (case-insensitive), we will match.
function parseCSV(text){
  const lines = text.trim().split(/\r?\n/);
  const rows = lines.map(l => l.split(",").map(x=>x.trim()));
  return rows;
}

/***********************
 * Helpers
 ***********************/
const $ = (id)=>document.getElementById(id);
const fmt = (n)=> (isFinite(n) ? n.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}) : "0.00");
const num = (v)=>{
  const x = parseFloat(String(v).replace(/[^0-9.\-]/g,""));
  return isFinite(x)?x:0;
};
const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));
const sum = (arr)=>arr.reduce((a,b)=>a+b,0);

function randColor(i){
  // stable-ish vivid palette
  const hues = [210, 300, 270, 30, 340, 160, 45, 190, 10, 120];
  const h = hues[i % hues.length];
  return `hsl(${h} 85% 55%)`;
}

function holdingsRows(){
  return [...$("holdingsTable").querySelectorAll("tbody tr")];
}

function getHoldings(){
  return holdingsRows().map(r=>{
    const t = (r.querySelector('[data-role="ticker"]').value||"").trim().toUpperCase();
    const target = num(r.querySelector('[data-role="target"]').value);
    const units = num(r.querySelector('[data-role="units"]').value);
    const price = num(r.querySelector('[data-role="price"]').value);
    const value = num(r.querySelector('[data-role="value"]').value);
    return { t, target, units, price, value };
  }).filter(x=>x.t.length>0);
}

function setStatus(text, ok=true){
  $("statusBadge").textContent = text;
  $("statusBadge").className = "badge " + (ok ? "ok" : "err");
  setTimeout(()=>{ $("statusBadge").textContent="Saved locally"; $("statusBadge").className="badge"; }, 900);
}

function autoValueForRow(r){
  const units = num(r.querySelector('[data-role="units"]').value);
  const price = num(r.querySelector('[data-role="price"]').value);
  const v = (units>0 && price>0) ? (units*price) : 0;
  if(v>0) r.querySelector('[data-role="value"]').value = fmt(v);
}

function attachRowListeners(r){
  const onAny = ()=>{
    autoValueForRow(r);
    saveState();
    // Also keep charts reasonably current without needing Calculate:
    drawBeforeChart();
  };

  ["input","change"].forEach(evt=>{
    r.querySelector('[data-role="ticker"]').addEventListener(evt, ()=>{ saveState(); });
    r.querySelector('[data-role="target"]').addEventListener(evt, ()=>{ saveState(); });
    r.querySelector('[data-role="units"]').addEventListener(evt, onAny);
    r.querySelector('[data-role="price"]').addEventListener(evt, onAny);
    r.querySelector('[data-role="value"]').addEventListener(evt, ()=>{ saveState(); drawBeforeChart(); });
  });

  r.querySelector('[data-role="del"]').addEventListener("click", ()=>{
    r.remove();
    buildBuyTable();
    saveState();
    drawBeforeChart();
  });
}

/***********************
 * Build tables
 ***********************/
function addHoldingRow(seed={}){
  const tbody = $("holdingsTable").querySelector("tbody");
  if(tbody.children.length >= MAX_HOLDINGS){
    alert("Max holdings reached (50).");
    return;
  }
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td>
      <input class="tickerCell tinyInput" data-role="ticker" placeholder="e.g. A200" value="${(seed.t||"").toUpperCase()}" />
    </td>
    <td class="right">
      <input class="money tinyInput" data-role="target" inputmode="decimal" value="${seed.target!=null ? fmt(seed.target) : "0"}" />
    </td>
    <td class="right">
      <input class="money tinyInput" data-role="units" inputmode="decimal" value="${seed.units!=null ? fmt(seed.units) : ""}" placeholder="0" />
    </td>
    <td class="right">
      <input class="money tinyInput" data-role="price" inputmode="decimal" value="${seed.price!=null ? fmt(seed.price) : ""}" placeholder="0" />
    </td>
    <td class="right">
      <input class="money tinyInput" data-role="value" inputmode="decimal" value="${seed.value!=null ? fmt(seed.value) : "0"}" />
    </td>
    <td class="center">
      <button class="delBtn" data-role="del" type="button">×</button>
    </td>
  `;
  tbody.appendChild(tr);
  attachRowListeners(tr);
  autoValueForRow(tr);
  buildBuyTable();
  saveState();
  drawBeforeChart();
}

function buildBuyTable(){
  const tbody = $("buyTable").querySelector("tbody");
  tbody.innerHTML = "";
  const hs = getHoldings();
  hs.forEach(h=>{
    const tr = document.createElement("tr");
    tr.dataset.ticker = h.t;
    tr.innerHTML = `
      <td class="tickerCell">${h.t}</td>
      <td class="right money" data-role="curPct">0.00%</td>
      <td class="right money" data-role="tgtPct">${h.target.toFixed(2)}%</td>
      <td class="right money" data-role="diff">0.00%</td>
      <td class="right money" data-role="buy">$0.00</td>
      <td class="right money" data-role="newPct">0.00%</td>
    `;
    tbody.appendChild(tr);
  });
}

/***********************
 * Normalize targets to 100
 ***********************/
function normalizeTargets(){
  const rows = holdingsRows();
  const targets = rows.map(r=>num(r.querySelector('[data-role="target"]').value));
  const total = sum(targets);
  if(total <= 0){
    alert("Set some target percentages first.");
    return;
  }
  rows.forEach((r,i)=>{
    const t = num(r.querySelector('[data-role="target"]').value);
    const newT = (t/total)*100;
    r.querySelector('[data-role="target"]').value = fmt(newT);
  });
  saveState();
  buildBuyTable();
  drawBeforeChart();
}

/***********************
 * Rebalance logic (new money only)
 ***********************/
function rebalance(){
  const minBuy = Math.max(1, Math.round(num($("minBuy").value)));
  const contribution = num($("contribution").value);
  const cashBet = num($("cashBetashares").value);
  const cashExtra = num($("cashExtra").value);
  const cashRem = num($("cashRemainder").value);

  const investable = contribution + cashBet + cashExtra + cashRem;

  const holdings = getHoldings();
  if(holdings.length === 0){
    alert("Add at least 1 holding.");
    return;
  }

  // compute values (prefer value input; if units*price exists it was auto-filled)
  const values = holdings.map(h=>h.value);
  const totalNow = sum(values);
  const totalAfter = totalNow + investable;

  // current pct
  const curPct = {};
  holdings.forEach(h=>{
    curPct[h.t] = totalNow>0 ? (h.value/totalNow)*100 : 0;
  });

  // target values after
  const targetValueAfter = {};
  holdings.forEach(h=>{
    targetValueAfter[h.t] = (h.target/100)*totalAfter;
  });

  // deficits
  const deficits = holdings.map(h=>{
    return { t:h.t, d: Math.max(0, targetValueAfter[h.t] - h.value) };
  });
  const totalDef = sum(deficits.map(x=>x.d));

  // raw buys proportional to deficits, fallback proportional to target
  const rawBuys = {};
  if(totalDef <= 1e-9){
    holdings.forEach(h=>{
      rawBuys[h.t] = (h.target/100)*investable;
    });
  }else{
    deficits.forEach(x=>{
      rawBuys[x.t] = (x.d/totalDef)*investable;
    });
  }

  // round to minBuy blocks
  const buys = {};
  let used = 0;
  holdings.forEach(h=>{
    const rb = Math.floor((rawBuys[h.t]||0) / minBuy) * minBuy;
    buys[h.t] = rb;
    used += rb;
  });

  let remainder = investable - used;
  if(remainder < 0) remainder = 0;

  // after values and new pct
  const afterValues = {};
  holdings.forEach(h=>{
    afterValues[h.t] = h.value + (buys[h.t]||0);
  });
  const totalAfterReal = sum(Object.values(afterValues)) + remainder;
  const newPct = {};
  holdings.forEach(h=>{
    newPct[h.t] = totalAfterReal>0 ? (afterValues[h.t]/totalAfterReal)*100 : 0;
  });

  // render buy table
  const rows = [...$("buyTable").querySelectorAll("tbody tr")];
  rows.forEach(r=>{
    const t = r.dataset.ticker;
    const h = holdings.find(x=>x.t===t);
    const cur = curPct[t] || 0;
    const tgt = h ? h.target : 0;
    const diff = cur - tgt;

    r.querySelector('[data-role="curPct"]').textContent = cur.toFixed(2) + "%";
    r.querySelector('[data-role="tgtPct"]').textContent = (tgt||0).toFixed(2) + "%";
    r.querySelector('[data-role="diff"]').textContent = (diff>=0?"+":"") + diff.toFixed(2) + "%";
    r.querySelector('[data-role="buy"]').textContent = "$" + fmt(buys[t] || 0);
    r.querySelector('[data-role="newPct"]').textContent = (newPct[t]||0).toFixed(2) + "%";
  });

  $("investedOut").value = fmt(used);
  $("remainderOut").value = fmt(remainder);
  $("postTotalOut").value = fmt(totalAfterReal);
  $("summaryBadge").textContent = `Investable: $${fmt(investable)} • Used: $${fmt(used)} • Leftover: $${fmt(remainder)}`;

  // persist remainder
  $("cashRemainder").value = fmt(remainder);

  drawCharts(holdings.map(h=>h.t), holdings.map(h=>h.value), holdings.map(h=>afterValues[h.t]||0));

  saveState();
}

/***********************
 * Charts
 ***********************/
let chartBefore, chartAfter;

function chartConfig(labels, data){
  const colors = labels.map((_,i)=>randColor(i));
  return {
    type:"doughnut",
    data:{ labels, datasets:[{ data, backgroundColor: colors, borderWidth:1, borderColor:"rgba(42,48,64,.7)" }] },
    options:{
      responsive:true,
      plugins:{
        legend:{
          position:"bottom",
          labels:{ color:"#ffffff", boxWidth:12 }
        },
        tooltip:{
          callbacks:{
            label:(ctx)=>{
              const v = ctx.raw||0;
              const total = ctx.dataset.data.reduce((a,b)=>a+b,0);
              const pct = total>0 ? (v/total*100) : 0;
              return ` ${ctx.label}: $${fmt(v)} (${pct.toFixed(2)}%)`;
            }
          }
        }
      },
      cutout:"62%"
    }
  };
}

function drawBeforeChart(){
  const hs = getHoldings();
  const labels = hs.map(h=>h.t);
  const data = hs.map(h=>h.value);
  const c1 = $("chartBefore").getContext("2d");
  if(chartBefore) chartBefore.destroy();
  chartBefore = new Chart(c1, chartConfig(labels, data));
}

function drawCharts(labels, beforeData, afterData){
  const c1 = $("chartBefore").getContext("2d");
  const c2 = $("chartAfter").getContext("2d");
  if(chartBefore) chartBefore.destroy();
  if(chartAfter) chartAfter.destroy();
  chartBefore = new Chart(c1, chartConfig(labels, beforeData));
  chartAfter  = new Chart(c2, chartConfig(labels, afterData));
}

/***********************
 * Fetch prices from CSV
 ***********************/
async function fetchPrices(){
  const url = $("csvUrl").value.trim();
  if(!url){
    alert("Paste a published CSV URL first.");
    return;
  }
  try{
    const res = await fetch(url, { cache:"no-store" });
    if(!res.ok) throw new Error("Fetch failed");
    const text = await res.text();
    const rows = parseCSV(text);
    if(rows.length < 2) throw new Error("CSV empty");

    // detect header
    const header = rows[0].map(h=>h.toLowerCase());
    const tIdx = header.findIndex(h=>["ticker","symbol","code"].includes(h));
    const pIdx = header.findIndex(h=>["price","last","close"].includes(h));
    if(tIdx === -1 || pIdx === -1){
      alert("CSV must have columns like: ticker,price");
      return;
    }

    const map = {};
    rows.slice(1).forEach(r=>{
      const t = (r[tIdx]||"").trim().toUpperCase();
      const p = num(r[pIdx]);
      if(t && p>0) map[t]=p;
    });

    // apply prices and update value if units exist
    holdingsRows().forEach(r=>{
      const t = (r.querySelector('[data-role="ticker"]').value||"").trim().toUpperCase();
      if(map[t]!=null){
        r.querySelector('[data-role="price"]').value = fmt(map[t]);
        autoValueForRow(r);
      }
    });

    setStatus("Prices updated", true);
    buildBuyTable();
    drawBeforeChart();
    saveState();
  }catch(e){
    setStatus("Price fetch error", false);
    alert("Could not fetch prices. Check the CSV link is published and accessible.");
  }
}

/***********************
 * Save/Load
 ***********************/
function saveState(){
  const state = {
    contribution: num($("contribution").value),
    cashBetashares: num($("cashBetashares").value),
    cashExtra: num($("cashExtra").value),
    cashRemainder: num($("cashRemainder").value),
    minBuy: num($("minBuy").value),
    csvUrl: $("csvUrl").value.trim(),
    holdings: holdingsRows().map(r=>({
      t: (r.querySelector('[data-role="ticker"]').value||"").trim().toUpperCase(),
      target: num(r.querySelector('[data-role="target"]').value),
      units: num(r.querySelector('[data-role="units"]').value),
      price: num(r.querySelector('[data-role="price"]').value),
      value: num(r.querySelector('[data-role="value"]').value),
    }))
  };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

function loadState(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw){
    // sensible starter rows
    addHoldingRow({t:"A200", target:25});
    addHoldingRow({t:"IVV", target:55});
    addHoldingRow({t:"DFND", target:10});
    addHoldingRow({t:"DRUG", target:10});
    buildBuyTable();
    drawBeforeChart();
    return;
  }
  try{
    const s = JSON.parse(raw);
    $("contribution").value = fmt(s.contribution||0);
    $("cashBetashares").value = fmt(s.cashBetashares||0);
    $("cashExtra").value = fmt(s.cashExtra||0);
    $("cashRemainder").value = fmt(s.cashRemainder||0);
    $("minBuy").value = (s.minBuy||50);
    $("csvUrl").value = (s.csvUrl||"");

    // rebuild rows
    $("holdingsTable").querySelector("tbody").innerHTML = "";
    (s.holdings||[]).forEach(h=>addHoldingRow(h));
    buildBuyTable();
    drawBeforeChart();
  }catch(e){
    localStorage.removeItem(STORAGE_KEY);
  }
}

function resetAll(){
  if(!confirm("Clear all saved data on this device?")) return;
  localStorage.removeItem(STORAGE_KEY);
  location.reload();
}

/***********************
 * Init
 ***********************/
function init(){
  $("logoImg").src = LOGO_FILE;

  // quick buttons
  document.querySelectorAll(".btnQuick").forEach(b=>{
    b.addEventListener("click", ()=>{
      $("contribution").value = fmt(num(b.dataset.q));
      saveState();
    });
  });

  $("calcBtn").addEventListener("click", rebalance);
  $("saveBtn").addEventListener("click", ()=>{ saveState(); setStatus("Saved", true); });
  $("resetBtn").addEventListener("click", resetAll);
  $("addBtn").addEventListener("click", ()=>addHoldingRow({t:"",target:0}));
  $("normBtn").addEventListener("click", normalizeTargets);
  $("fetchBtn").addEventListener("click", fetchPrices);

  // Autosave on core fields + live update charts
  ["contribution","cashBetashares","cashExtra","cashRemainder","minBuy","csvUrl"].forEach(id=>{
    $(id).addEventListener("input", ()=>{ saveState(); });
  });

  loadState();
}

init();
</script>
</body>
</html>
